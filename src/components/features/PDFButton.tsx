'use client';

import { useState, useRef } from 'react';
import type { AcademicEvent } from '@/lib/types';
import { toWareki } from '@/lib/academic';

interface PDFButtonProps {
  events: AcademicEvent[];
  birthYear: number;
  birthMonth: number;
  birthDay: number;
}

export function PDFButton({ events, birthYear, birthMonth, birthDay }: PDFButtonProps) {
  const [isGenerating, setIsGenerating] = useState(false);
  const containerRef = useRef<HTMLDivElement>(null);

  const generatePDF = async () => {
    setIsGenerating(true);
    
    try {
      // å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      const [jsPDFModule, html2canvasModule] = await Promise.all([
        import('jspdf'),
        import('html2canvas')
      ]);
      const jsPDF = jsPDFModule.default;
      const html2canvas = html2canvasModule.default;

      // ä¸€æ™‚çš„ãªHTMLè¦ç´ ã‚’ä½œæˆ
      const tempDiv = document.createElement('div');
      tempDiv.style.cssText = `
        position: absolute;
        left: -9999px;
        top: 0;
        width: 595px;
        padding: 40px;
        background: white;
        font-family: "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
        color: #1a1a1a;
      `;

      // HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ§‹ç¯‰
      tempDiv.innerHTML = `
        <div style="text-align: center; margin-bottom: 24px;">
          <h1 style="font-size: 28px; font-weight: bold; color: #2C5282; margin: 0 0 12px 0;">
            ğŸ“š å­¦æ­´æ—©è¦‹è¡¨
          </h1>
          <p style="font-size: 16px; color: #4a5568; margin: 0;">
            ç”Ÿå¹´æœˆæ—¥: ${birthYear}å¹´${birthMonth}æœˆ${birthDay}æ—¥ (${toWareki(birthYear, birthMonth)})
          </p>
        </div>
        <hr style="border: none; border-top: 2px solid #e2e8f0; margin: 20px 0;" />
        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
          <thead>
            <tr style="background: #f7fafc;">
              <th style="padding: 10px 8px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #2C5282; font-weight: 600;">å¹´æœˆ</th>
              <th style="padding: 10px 8px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #2C5282; font-weight: 600;">ã‚¤ãƒ™ãƒ³ãƒˆ</th>
              <th style="padding: 10px 8px; text-align: right; border-bottom: 2px solid #e2e8f0; color: #2C5282; font-weight: 600;">å¹´é½¢</th>
            </tr>
          </thead>
          <tbody>
            ${events.map((event, i) => `
              <tr style="background: ${i % 2 === 0 ? '#ffffff' : '#f9fafb'};">
                <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; white-space: nowrap;">
                  ${event.year}å¹´${event.month}æœˆ<br/>
                  <span style="font-size: 11px; color: #718096;">(${toWareki(event.year, event.month)})</span>
                </td>
                <td style="padding: 8px; border-bottom: 1px solid #e2e8f0;">
                  <span style="color: ${event.event.includes('å…¥å­¦') ? '#D53F8C' : event.event.includes('å’æ¥­') ? '#2C5282' : '#4a5568'}; font-weight: ${event.event.includes('å…¥å­¦') || event.event.includes('å’æ¥­') ? '600' : '400'};">
                    ${event.event}
                  </span>
                </td>
                <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">
                  ${event.age}æ­³
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <hr style="border: none; border-top: 2px solid #e2e8f0; margin: 20px 0;" />
        <p style="text-align: center; font-size: 11px; color: #a0aec0; margin: 0;">
          Generated by å­¦æ­´æ—©è¦‹è¡¨ - sotsugyoutoshihayamihyou.vercel.app
        </p>
      `;

      document.body.appendChild(tempDiv);

      // html2canvasã§ã‚­ãƒ£ãƒ—ãƒãƒ£
      const canvas = await html2canvas(tempDiv, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
      });

      document.body.removeChild(tempDiv);

      // PDFã‚’ä½œæˆ
      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 210; // A4å¹… (mm)
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      
      const doc = new jsPDF({
        orientation: imgHeight > 297 ? 'portrait' : 'portrait',
        unit: 'mm',
        format: 'a4',
      });

      // ãƒšãƒ¼ã‚¸åˆ†å‰²å‡¦ç†
      const pageHeight = 297; // A4é«˜ã• (mm)
      let heightLeft = imgHeight;
      let position = 0;
      
      doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
      
      while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        doc.addPage();
        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      doc.save(`å­¦æ­´æ—©è¦‹è¡¨_${birthYear}å¹´${birthMonth}æœˆ${birthDay}æ—¥ç”Ÿã¾ã‚Œ.pdf`);
    } catch (error) {
      console.error('PDF generation failed:', error);
      alert('PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    } finally {
      setIsGenerating(false);
    }
  };

  return (
    <button
      onClick={generatePDF}
      disabled={isGenerating}
      className="w-full px-4 py-3 rounded-xl font-medium transition-all flex items-center justify-center gap-2"
      style={{
        background: isGenerating ? 'var(--color-border)' : 'var(--color-card)',
        color: isGenerating ? 'var(--color-text-muted)' : 'var(--color-primary)',
        border: '1px solid var(--color-border)',
        cursor: isGenerating ? 'not-allowed' : 'pointer',
      }}
    >
      {isGenerating ? (
        <>
          <svg className="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
          </svg>
          PDFç”Ÿæˆä¸­...
        </>
      ) : (
        <>
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </>
      )}
    </button>
  );
}
